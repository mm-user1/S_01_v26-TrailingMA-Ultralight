<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrailingMA Backtester</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #e8e8e8;
            padding: 20px;
            color: #2a2a2a;
        }

        .window {
            background: #f5f5f5;
            border: 1px solid #999999;
            border-radius: 4px;
            max-width: 800px;
            margin: 0 auto;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
        }

        .title-bar {
            background: #4a4a4a;
            color: #ffffff;
            padding: 8px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 4px 4px 0 0;
        }

        .title-bar h2 {
            font-size: 15px;
            font-weight: 500;
        }

        .window-controls {
            display: flex;
            gap: 8px;
        }

        .window-controls button {
            background: none;
            border: none;
            color: #ffffff;
            cursor: pointer;
            padding: 4px 8px;
            font-size: 16px;
        }

        .content {
            padding: 20px;
        }

        .section {
            margin-bottom: 20px;
        }

        .section-title {
            color: #3a3a3a;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            padding-bottom: 6px;
            border-bottom: 1px solid #bbbbbb;
        }

        .form-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .form-group.vertical {
            flex-direction: column;
            align-items: flex-start;
            gap: 6px;
        }

        .form-group.with-ma {
            flex-direction: column;
            align-items: flex-start;
            gap: 8px;
        }

        label {
            color: #2a2a2a;
            font-size: 14px;
            min-width: 120px;
        }

        input[type="text"],
        input[type="number"],
        select {
            background: #ffffff;
            border: 1px solid #999999;
            color: #2a2a2a;
            padding: 6px 10px;
            border-radius: 3px;
            font-size: 14px;
            width: 100px;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus {
            outline: none;
            border-color: #5a5a5a;
            box-shadow: 0 0 0 2px rgba(90, 90, 90, 0.2);
        }

        input[type="file"] {
            font-size: 13px;
        }

        input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .date-input {
            width: 150px;
        }

        .small-input {
            width: 80px !important;
        }

        .calendar-btn {
            padding: 6px 10px;
            background: #dddddd;
            border: 1px solid #999999;
            color: #2a2a2a;
            cursor: pointer;
            font-size: 14px;
        }

        .calendar-btn:hover {
            background: #cccccc;
        }

        .inline-group {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .param-group {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: #e8e8e8;
            border-radius: 3px;
            margin-bottom: 8px;
            border: 1px solid #cccccc;
        }

        .param-group label {
            min-width: auto;
            font-size: 13px;
        }

        .param-group input {
            width: 70px;
        }

        .collapsible {
            background: #e8e8e8;
            border-radius: 3px;
            margin-bottom: 10px;
            border: 1px solid #bbbbbb;
        }

        .collapsible-header {
            padding: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .collapsible-header:hover {
            background: #dddddd;
        }

        .collapsible-icon {
            font-size: 10px;
            color: #5a5a5a;
            transition: transform 0.2s ease;
        }

        .collapsible.open .collapsible-icon {
            transform: rotate(180deg);
        }

        .collapsible-content {
            padding: 10px;
            border-top: 1px solid #bbbbbb;
            background: #f5f5f5;
            display: none;
        }

        .collapsible.open .collapsible-content {
            display: block;
        }

        .ma-selector {
            display: flex;
            flex-direction: column;
            gap: 4px;
            background: #ffffff;
            border: 1px solid #999999;
            padding: 8px;
            border-radius: 3px;
        }

        .ma-row {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .ma-option {
            display: flex;
            align-items: center;
            gap: 4px;
            min-width: 80px;
        }

        .ma-option input[type="checkbox"] {
            width: 14px;
            height: 14px;
        }

        .ma-option label {
            font-size: 13px;
            min-width: auto;
            cursor: pointer;
        }

        .results-area {
            background: #e8e8e8;
            border: 1px solid #999999;
            border-radius: 3px;
            min-height: 200px;
            padding: 15px;
            color: #777777;
            font-style: italic;
            font-size: 14px;
            white-space: pre-wrap;
        }

        .results-area.ready {
            color: #2a2a2a;
            font-style: normal;
        }

        .results-area.loading {
            color: #777777;
        }

        .button-group {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #bbbbbb;
        }

        button {
            background: #4a4a4a;
            color: #ffffff;
            border: none;
            padding: 8px 20px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s ease;
        }

        button:hover {
            background: #3a3a3a;
        }

        button.secondary {
            background: #cccccc;
            color: #2a2a2a;
        }

        button.secondary:hover {
            background: #bbbbbb;
        }

        .error {
            color: #b33434;
            margin-top: 10px;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <div class="window">
        <div class="title-bar">
            <h2>S_01 TrailingMA Backtester</h2>
            <div class="window-controls">
                <button type="button">‚àí</button>
                <button type="button">‚ñ°</button>
                <button type="button">√ó</button>
            </div>
        </div>
        <div class="content">
            <form id="backtestForm">
                <div class="section">
                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="dateFilter">
                            <label for="dateFilter">Date Filter</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="backtester">
                            <label for="backtester">Backtester</label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="startDate">Start Date</label>
                        <input type="text" id="startDate" class="date-input" autocomplete="off">
                        <button type="button" class="calendar-btn" tabindex="-1">üìÖ</button>
                        <input type="text" id="startTime" class="small-input" autocomplete="off">
                    </div>

                    <div class="form-group">
                        <label for="endDate">End Date</label>
                        <input type="text" id="endDate" class="date-input" autocomplete="off">
                        <button type="button" class="calendar-btn" tabindex="-1">üìÖ</button>
                        <input type="text" id="endTime" class="small-input" autocomplete="off">
                    </div>

                    <div class="form-group vertical">
                        <label for="csvFile">CSV —Ñ–∞–π–ª (OHLCV)</label>
                        <input type="file" id="csvFile" accept=".csv">
                    </div>
                </div>

                <div class="section">
                    <div class="form-group with-ma">
                        <label>T MA Type</label>
                        <div class="ma-selector" data-group="trend">
                            <div class="ma-row">
                                <div class="ma-option">
                                    <input type="checkbox" id="trend-all" data-group="trend" data-type="ALL">
                                    <label for="trend-all">ALL</label>
                                </div>
                                <div class="ma-option">
                                    <input type="checkbox" id="trend-ema" data-group="trend" data-type="EMA">
                                    <label for="trend-ema">EMA</label>
                                </div>
                                <div class="ma-option">
                                    <input type="checkbox" id="trend-sma" data-group="trend" data-type="SMA">
                                    <label for="trend-sma">SMA</label>
                                </div>
                                <div class="ma-option">
                                    <input type="checkbox" id="trend-hma" data-group="trend" data-type="HMA">
                                    <label for="trend-hma">HMA</label>
                                </div>
                                <div class="ma-option">
                                    <input type="checkbox" id="trend-wma" data-group="trend" data-type="WMA">
                                    <label for="trend-wma">WMA</label>
                                </div>
                                <div class="ma-option">
                                    <input type="checkbox" id="trend-alma" data-group="trend" data-type="ALMA">
                                    <label for="trend-alma">ALMA</label>
                                </div>
                            </div>
                            <div class="ma-row">
                                <div class="ma-option">
                                    <input type="checkbox" id="trend-kama" data-group="trend" data-type="KAMA">
                                    <label for="trend-kama">KAMA</label>
                                </div>
                                <div class="ma-option">
                                    <input type="checkbox" id="trend-tma" data-group="trend" data-type="TMA">
                                    <label for="trend-tma">TMA</label>
                                </div>
                                <div class="ma-option">
                                    <input type="checkbox" id="trend-t3" data-group="trend" data-type="T3">
                                    <label for="trend-t3">T3</label>
                                </div>
                                <div class="ma-option">
                                    <input type="checkbox" id="trend-dema" data-group="trend" data-type="DEMA">
                                    <label for="trend-dema">DEMA</label>
                                </div>
                                <div class="ma-option">
                                    <input type="checkbox" id="trend-vwma" data-group="trend" data-type="VWMA">
                                    <label for="trend-vwma">VWMA</label>
                                </div>
                                <div class="ma-option">
                                    <input type="checkbox" id="trend-vwap" data-group="trend" data-type="VWAP">
                                    <label for="trend-vwap">VWAP</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="maLength">Length</label>
                        <input type="number" id="maLength" min="0">
                    </div>

                    <div class="form-group">
                        <label for="closeCountLong">Close Count Long</label>
                        <input type="number" id="closeCountLong" min="0">
                        <label for="closeCountShort">Close Count Short</label>
                        <input type="number" id="closeCountShort" min="0">
                    </div>
                </div>

                <div class="collapsible open">
                    <div class="collapsible-header">
                        <span class="collapsible-icon">‚ñº</span>
                        <span class="section-title" style="margin: 0; border: none;">STOPS AND FILTERS</span>
                    </div>
                    <div class="collapsible-content">
                        <div class="param-group">
                            <label for="stopLongX">Stop Long X</label>
                            <input type="number" id="stopLongX" step="0.1" min="0">
                            <label for="stopLongRR">RR</label>
                            <input type="number" id="stopLongRR" step="0.1" min="0">
                            <label for="stopLongLP">LP</label>
                            <input type="number" id="stopLongLP" min="1">
                        </div>

                        <div class="param-group">
                            <label for="stopShortX">Stop Short X</label>
                            <input type="number" id="stopShortX" step="0.1" min="0">
                            <label for="stopShortRR">RR</label>
                            <input type="number" id="stopShortRR" step="0.1" min="0">
                            <label for="stopShortLP">LP</label>
                            <input type="number" id="stopShortLP" min="1">
                        </div>

                        <div class="param-group">
                            <label for="stopLongMaxPct">L Stop Max %</label>
                            <input type="number" id="stopLongMaxPct" step="0.1" min="0">
                            <label for="stopShortMaxPct">S Stop Max %</label>
                            <input type="number" id="stopShortMaxPct" step="0.1" min="0">
                        </div>

                        <div class="param-group">
                            <label for="stopLongMaxDays">L Stop Max D</label>
                            <input type="number" id="stopLongMaxDays" min="0">
                            <label for="stopShortMaxDays">S Stop Max D</label>
                            <input type="number" id="stopShortMaxDays" min="0">
                        </div>
                    </div>
                </div>

                <div class="collapsible open">
                    <div class="collapsible-header">
                        <span class="collapsible-icon">‚ñº</span>
                        <span class="section-title" style="margin: 0; border: none;">TRAILING STOPS</span>
                    </div>
                    <div class="collapsible-content">
                        <div class="param-group">
                            <label for="trailRRLong">Trail RR Long</label>
                            <input type="number" id="trailRRLong" step="0.1" min="0">
                            <label for="trailRRShort">Trail RR Short</label>
                            <input type="number" id="trailRRShort" step="0.1" min="0">
                        </div>

                        <div class="param-group" style="flex-direction: column; align-items: flex-start;">
                            <label>Trail MA Long</label>
                            <div class="ma-selector" data-group="trailLong">
                                <div class="ma-row">
                                    <div class="ma-option">
                                        <input type="checkbox" id="trailLong-all" data-group="trailLong" data-type="ALL">
                                        <label for="trailLong-all">ALL</label>
                                    </div>
                                    <div class="ma-option">
                                        <input type="checkbox" id="trailLong-ema" data-group="trailLong" data-type="EMA">
                                        <label for="trailLong-ema">EMA</label>
                                    </div>
                                    <div class="ma-option">
                                        <input type="checkbox" id="trailLong-sma" data-group="trailLong" data-type="SMA">
                                        <label for="trailLong-sma">SMA</label>
                                    </div>
                                    <div class="ma-option">
                                        <input type="checkbox" id="trailLong-hma" data-group="trailLong" data-type="HMA">
                                        <label for="trailLong-hma">HMA</label>
                                    </div>
                                    <div class="ma-option">
                                        <input type="checkbox" id="trailLong-wma" data-group="trailLong" data-type="WMA">
                                        <label for="trailLong-wma">WMA</label>
                                    </div>
                                    <div class="ma-option">
                                        <input type="checkbox" id="trailLong-alma" data-group="trailLong" data-type="ALMA">
                                        <label for="trailLong-alma">ALMA</label>
                                    </div>
                                </div>
                                <div class="ma-row">
                                    <div class="ma-option">
                                        <input type="checkbox" id="trailLong-kama" data-group="trailLong" data-type="KAMA">
                                        <label for="trailLong-kama">KAMA</label>
                                    </div>
                                    <div class="ma-option">
                                        <input type="checkbox" id="trailLong-tma" data-group="trailLong" data-type="TMA">
                                        <label for="trailLong-tma">TMA</label>
                                    </div>
                                    <div class="ma-option">
                                        <input type="checkbox" id="trailLong-t3" data-group="trailLong" data-type="T3">
                                        <label for="trailLong-t3">T3</label>
                                    </div>
                                    <div class="ma-option">
                                        <input type="checkbox" id="trailLong-dema" data-group="trailLong" data-type="DEMA">
                                        <label for="trailLong-dema">DEMA</label>
                                    </div>
                                    <div class="ma-option">
                                        <input type="checkbox" id="trailLong-vwma" data-group="trailLong" data-type="VWMA">
                                        <label for="trailLong-vwma">VWMA</label>
                                    </div>
                                    <div class="ma-option">
                                        <input type="checkbox" id="trailLong-vwap" data-group="trailLong" data-type="VWAP">
                                        <label for="trailLong-vwap">VWAP</label>
                                    </div>
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px; margin-top: 8px; align-items: center;">
                                <label for="trailLongLength">Length</label>
                                <input type="number" id="trailLongLength" min="0">
                                <label for="trailLongOffset">Offset</label>
                                <input type="number" id="trailLongOffset" step="0.1">
                            </div>
                        </div>

                        <div class="param-group" style="flex-direction: column; align-items: flex-start;">
                            <label>Trail MA Short</label>
                            <div class="ma-selector" data-group="trailShort">
                                <div class="ma-row">
                                    <div class="ma-option">
                                        <input type="checkbox" id="trailShort-all" data-group="trailShort" data-type="ALL">
                                        <label for="trailShort-all">ALL</label>
                                    </div>
                                    <div class="ma-option">
                                        <input type="checkbox" id="trailShort-ema" data-group="trailShort" data-type="EMA">
                                        <label for="trailShort-ema">EMA</label>
                                    </div>
                                    <div class="ma-option">
                                        <input type="checkbox" id="trailShort-sma" data-group="trailShort" data-type="SMA">
                                        <label for="trailShort-sma">SMA</label>
                                    </div>
                                    <div class="ma-option">
                                        <input type="checkbox" id="trailShort-hma" data-group="trailShort" data-type="HMA">
                                        <label for="trailShort-hma">HMA</label>
                                    </div>
                                    <div class="ma-option">
                                        <input type="checkbox" id="trailShort-wma" data-group="trailShort" data-type="WMA">
                                        <label for="trailShort-wma">WMA</label>
                                    </div>
                                    <div class="ma-option">
                                        <input type="checkbox" id="trailShort-alma" data-group="trailShort" data-type="ALMA">
                                        <label for="trailShort-alma">ALMA</label>
                                    </div>
                                </div>
                                <div class="ma-row">
                                    <div class="ma-option">
                                        <input type="checkbox" id="trailShort-kama" data-group="trailShort" data-type="KAMA">
                                        <label for="trailShort-kama">KAMA</label>
                                    </div>
                                    <div class="ma-option">
                                        <input type="checkbox" id="trailShort-tma" data-group="trailShort" data-type="TMA">
                                        <label for="trailShort-tma">TMA</label>
                                    </div>
                                    <div class="ma-option">
                                        <input type="checkbox" id="trailShort-t3" data-group="trailShort" data-type="T3">
                                        <label for="trailShort-t3">T3</label>
                                    </div>
                                    <div class="ma-option">
                                        <input type="checkbox" id="trailShort-dema" data-group="trailShort" data-type="DEMA">
                                        <label for="trailShort-dema">DEMA</label>
                                    </div>
                                    <div class="ma-option">
                                        <input type="checkbox" id="trailShort-vwma" data-group="trailShort" data-type="VWMA">
                                        <label for="trailShort-vwma">VWMA</label>
                                    </div>
                                    <div class="ma-option">
                                        <input type="checkbox" id="trailShort-vwap" data-group="trailShort" data-type="VWAP">
                                        <label for="trailShort-vwap">VWAP</label>
                                    </div>
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px; margin-top: 8px; align-items: center;">
                                <label for="trailShortLength">Length</label>
                                <input type="number" id="trailShortLength" min="0">
                                <label for="trailShortOffset">Offset</label>
                                <input type="number" id="trailShortOffset" step="0.1">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <div class="form-group">
                        <label for="riskPerTrade">Risk Per Trade</label>
                        <input type="number" id="riskPerTrade" step="0.01" min="0">
                        <label for="contractSize">Contract Size</label>
                        <input type="number" id="contractSize" step="0.01" min="0">
                    </div>
                </div>

                <div class="section">
                    <div class="section-title">Results</div>
                    <div id="results" class="results-area">–ù–∞–∂–º–∏—Ç–µ ¬´Run¬ª –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –±—ç–∫—Ç–µ—Å—Ç–∞‚Ä¶</div>
                    <div id="error" class="error" role="alert" style="display:none;"></div>
                </div>

                <div class="button-group">
                    <button type="button" class="secondary" id="defaultsBtn">Defaults</button>
                    <div style="display: flex; gap: 10px;">
                        <button type="button" class="secondary" id="cancelBtn">Cancel</button>
                        <button type="submit" id="runBtn">Run</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script>
        const MA_TYPES = [
            'EMA', 'SMA', 'HMA', 'WMA', 'ALMA', 'KAMA', 'TMA', 'T3', 'DEMA', 'VWMA', 'VWAP'
        ];

        const collapsibles = document.querySelectorAll('.collapsible');
        collapsibles.forEach((collapsible) => {
            const header = collapsible.querySelector('.collapsible-header');
            header.addEventListener('click', () => {
                collapsible.classList.toggle('open');
            });
        });

        const defaults = {
            dateFilter: true,
            backtester: true,
            startDate: '2025-04-01',
            startTime: '00:00',
            endDate: '2025-09-01',
            endTime: '00:00',
            trendMATypes: [...MA_TYPES],
            maLength: 45,
            closeCountLong: 7,
            closeCountShort: 5,
            stopLongX: 2,
            stopLongRR: 3,
            stopLongLP: 2,
            stopShortX: 2,
            stopShortRR: 3,
            stopShortLP: 2,
            stopLongMaxPct: 3,
            stopShortMaxPct: 3,
            stopLongMaxDays: 2,
            stopShortMaxDays: 4,
            trailRRLong: 1,
            trailRRShort: 1,
            trailLongTypes: [...MA_TYPES],
            trailLongLength: 160,
            trailLongOffset: -1,
            trailShortTypes: [...MA_TYPES],
            trailShortLength: 160,
            trailShortOffset: 1,
            riskPerTrade: 2,
            contractSize: 0.01
        };

        function setCheckboxGroup(group, selectedTypes) {
            const allCheckbox = document.querySelector(`input[data-group="${group}"][data-type="ALL"]`);
            const checkboxes = Array.from(document.querySelectorAll(`input[data-group="${group}"]:not([data-type="ALL"])`));
            const normalized = new Set(selectedTypes);
            const shouldSelectAll = MA_TYPES.every((type) => normalized.has(type));
            allCheckbox.checked = shouldSelectAll;
            checkboxes.forEach((checkbox) => {
                checkbox.checked = shouldSelectAll || normalized.has(checkbox.dataset.type);
            });
        }

        function collectSelectedTypes(group) {
            const allCheckbox = document.querySelector(`input[data-group="${group}"][data-type="ALL"]`);
            const checkboxes = Array.from(document.querySelectorAll(`input[data-group="${group}"]:not([data-type="ALL"])`));
            if (allCheckbox.checked) {
                return [...MA_TYPES];
            }
            const chosen = checkboxes.filter((checkbox) => checkbox.checked).map((checkbox) => checkbox.dataset.type);
            return chosen;
        }

        function syncAllToggle(group) {
            const allCheckbox = document.querySelector(`input[data-group="${group}"][data-type="ALL"]`);
            const checkboxes = Array.from(document.querySelectorAll(`input[data-group="${group}"]:not([data-type="ALL"])`));
            const allChecked = checkboxes.every((checkbox) => checkbox.checked);
            allCheckbox.checked = allChecked;
        }

        function bindMASelectors() {
            ['trend', 'trailLong', 'trailShort'].forEach((group) => {
                const allCheckbox = document.querySelector(`input[data-group="${group}"][data-type="ALL"]`);
                const checkboxes = Array.from(document.querySelectorAll(`input[data-group="${group}"]:not([data-type="ALL"])`));

                allCheckbox.addEventListener('change', () => {
                    checkboxes.forEach((checkbox) => {
                        checkbox.checked = allCheckbox.checked;
                    });
                });

                checkboxes.forEach((checkbox) => {
                    checkbox.addEventListener('change', () => {
                        syncAllToggle(group);
                    });
                });
            });
        }

        function applyDefaults() {
            document.getElementById('dateFilter').checked = defaults.dateFilter;
            document.getElementById('backtester').checked = defaults.backtester;
            document.getElementById('startDate').value = defaults.startDate;
            document.getElementById('startTime').value = defaults.startTime;
            document.getElementById('endDate').value = defaults.endDate;
            document.getElementById('endTime').value = defaults.endTime;
            document.getElementById('maLength').value = defaults.maLength;
            document.getElementById('closeCountLong').value = defaults.closeCountLong;
            document.getElementById('closeCountShort').value = defaults.closeCountShort;
            document.getElementById('stopLongX').value = defaults.stopLongX;
            document.getElementById('stopLongRR').value = defaults.stopLongRR;
            document.getElementById('stopLongLP').value = defaults.stopLongLP;
            document.getElementById('stopShortX').value = defaults.stopShortX;
            document.getElementById('stopShortRR').value = defaults.stopShortRR;
            document.getElementById('stopShortLP').value = defaults.stopShortLP;
            document.getElementById('stopLongMaxPct').value = defaults.stopLongMaxPct;
            document.getElementById('stopShortMaxPct').value = defaults.stopShortMaxPct;
            document.getElementById('stopLongMaxDays').value = defaults.stopLongMaxDays;
            document.getElementById('stopShortMaxDays').value = defaults.stopShortMaxDays;
            document.getElementById('trailRRLong').value = defaults.trailRRLong;
            document.getElementById('trailRRShort').value = defaults.trailRRShort;
            document.getElementById('trailLongLength').value = defaults.trailLongLength;
            document.getElementById('trailLongOffset').value = defaults.trailLongOffset;
            document.getElementById('trailShortLength').value = defaults.trailShortLength;
            document.getElementById('trailShortOffset').value = defaults.trailShortOffset;
            document.getElementById('riskPerTrade').value = defaults.riskPerTrade;
            document.getElementById('contractSize').value = defaults.contractSize;
            setCheckboxGroup('trend', defaults.trendMATypes);
            setCheckboxGroup('trailLong', defaults.trailLongTypes);
            setCheckboxGroup('trailShort', defaults.trailShortTypes);
            const resultsEl = document.getElementById('results');
            resultsEl.textContent = '–ù–∞–∂–º–∏—Ç–µ ¬´Run¬ª –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –±—ç–∫—Ç–µ—Å—Ç–∞‚Ä¶';
            resultsEl.classList.remove('ready', 'loading');
            document.getElementById('error').style.display = 'none';
        }

        function composeDateTime(datePart, timePart) {
            const date = (datePart || '').trim();
            const time = (timePart || '').trim();
            if (!date) {
                return '';
            }
            const normalizedTime = time || '00:00';
            return `${date}T${normalizedTime}`;
        }

        function gatherFormState() {
            const start = composeDateTime(document.getElementById('startDate').value, document.getElementById('startTime').value);
            const end = composeDateTime(document.getElementById('endDate').value, document.getElementById('endTime').value);

            const trendTypes = collectSelectedTypes('trend');
            const trailLongTypes = collectSelectedTypes('trailLong');
            const trailShortTypes = collectSelectedTypes('trailShort');

            return {
                start,
                end,
                trendTypes,
                trailLongTypes,
                trailShortTypes,
                payload: {
                    dateFilter: document.getElementById('dateFilter').checked,
                    backtester: document.getElementById('backtester').checked,
                    start,
                    end,
                    maLength: Number(document.getElementById('maLength').value),
                    closeCountLong: Number(document.getElementById('closeCountLong').value),
                    closeCountShort: Number(document.getElementById('closeCountShort').value),
                    stopLongX: Number(document.getElementById('stopLongX').value),
                    stopLongRR: Number(document.getElementById('stopLongRR').value),
                    stopLongLP: Number(document.getElementById('stopLongLP').value),
                    stopShortX: Number(document.getElementById('stopShortX').value),
                    stopShortRR: Number(document.getElementById('stopShortRR').value),
                    stopShortLP: Number(document.getElementById('stopShortLP').value),
                    stopLongMaxPct: Number(document.getElementById('stopLongMaxPct').value),
                    stopShortMaxPct: Number(document.getElementById('stopShortMaxPct').value),
                    stopLongMaxDays: Number(document.getElementById('stopLongMaxDays').value),
                    stopShortMaxDays: Number(document.getElementById('stopShortMaxDays').value),
                    trailRRLong: Number(document.getElementById('trailRRLong').value),
                    trailRRShort: Number(document.getElementById('trailRRShort').value),
                    trailLongLength: Number(document.getElementById('trailLongLength').value),
                    trailLongOffset: Number(document.getElementById('trailLongOffset').value),
                    trailShortLength: Number(document.getElementById('trailShortLength').value),
                    trailShortOffset: Number(document.getElementById('trailShortOffset').value),
                    riskPerTrade: Number(document.getElementById('riskPerTrade').value),
                    contractSize: Number(document.getElementById('contractSize').value)
                }
            };
        }

        function formatMetric(value, digits = 2) {
            if (typeof value === 'number' && Number.isFinite(value)) {
                return value.toFixed(digits);
            }
            return value ?? '‚Äî';
        }

        function formatResultBlock(index, total, payload, data) {
            const metrics = data.metrics || {};
            return [
                `#${index}/${total}`,
                `Trend MA: ${payload.maType}`,
                `Trail MA Long: ${payload.trailLongType}`,
                `Trail MA Short: ${payload.trailShortType}`,
                `Net Profit %: ${formatMetric(metrics.net_profit_pct)}`,
                `Max Drawdown %: ${formatMetric(metrics.max_drawdown_pct)}`,
                `Total Trades: ${metrics.total_trades ?? '‚Äî'}`
            ].join('\n');
        }

        async function submitForm(event) {
            event.preventDefault();
            const resultsEl = document.getElementById('results');
            const errorEl = document.getElementById('error');
            const fileInput = document.getElementById('csvFile');

            errorEl.style.display = 'none';
            resultsEl.classList.remove('ready');

            if (!fileInput.files.length) {
                errorEl.textContent = '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ CSV —Ñ–∞–π–ª —Å –¥–∞–Ω–Ω—ã–º–∏.';
                errorEl.style.display = 'block';
                return;
            }

            const state = gatherFormState();
            if (!state.start || !state.end) {
                errorEl.textContent = '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞ –∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è.';
                errorEl.style.display = 'block';
                return;
            }

            if (!state.trendTypes.length || !state.trailLongTypes.length || !state.trailShortTypes.length) {
                errorEl.textContent = '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω MA –≤ –∫–∞–∂–¥–æ–π –≥—Ä—É–ø–ø–µ.';
                errorEl.style.display = 'block';
                return;
            }

            const combinations = [];
            state.trendTypes.forEach((trendType) => {
                state.trailLongTypes.forEach((trailLongType) => {
                    state.trailShortTypes.forEach((trailShortType) => {
                        combinations.push({ trendType, trailLongType, trailShortType });
                    });
                });
            });

            if (!combinations.length) {
                errorEl.textContent = '–ù–µ—Ç –∫–æ–º–±–∏–Ω–∞—Ü–∏–π –¥–ª—è –∑–∞–ø—É—Å–∫–∞.';
                errorEl.style.display = 'block';
                return;
            }

            resultsEl.textContent = '–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ä–∞—Å—á—ë—Ç‚Ä¶';
            resultsEl.classList.add('loading');

            const aggregatedResults = [];

            for (let index = 0; index < combinations.length; index += 1) {
                const combo = combinations[index];
                const payload = {
                    ...state.payload,
                    maType: combo.trendType,
                    trailLongType: combo.trailLongType,
                    trailShortType: combo.trailShortType
                };

                const formData = new FormData();
                formData.append('file', fileInput.files[0]);
                formData.append('payload', JSON.stringify(payload));

                resultsEl.textContent = `–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ä–∞—Å—á—ë—Ç‚Ä¶ (${index + 1}/${combinations.length})`;

                try {
                    const response = await fetch('/api/backtest', {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        const message = await response.text();
                        throw new Error(message || '–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –±—ç–∫—Ç–µ—Å—Ç–∞');
                    }

                    const data = await response.json();
                    aggregatedResults.push(formatResultBlock(index + 1, combinations.length, payload, data));
                } catch (err) {
                    resultsEl.textContent = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞.';
                    resultsEl.classList.remove('loading');
                    errorEl.textContent = err.message;
                    errorEl.style.display = 'block';
                    return;
                }
            }

            resultsEl.textContent = aggregatedResults.join('\n\n');
            resultsEl.classList.remove('loading');
            resultsEl.classList.add('ready');
        }

        document.getElementById('defaultsBtn').addEventListener('click', () => {
            applyDefaults();
        });

        document.getElementById('cancelBtn').addEventListener('click', () => {
            document.getElementById('backtestForm').reset();
            applyDefaults();
        });

        document.getElementById('backtestForm').addEventListener('submit', submitForm);

        bindMASelectors();
        applyDefaults();
    </script>
</body>
</html>
