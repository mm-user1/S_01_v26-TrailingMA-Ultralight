<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrailingMA Backtester</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #e8e8e8;
            padding: 20px;
            color: #2a2a2a;
        }

        .window {
            background: #f5f5f5;
            border: 1px solid #999999;
            border-radius: 6px;
            max-width: 920px;
            margin: 0 auto;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.15);
        }

        .title-bar {
            background: #4a4a4a;
            color: #ffffff;
            padding: 10px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 6px 6px 0 0;
        }

        .title-bar h2 {
            font-size: 16px;
            font-weight: 500;
        }

        .window-controls {
            display: flex;
            gap: 8px;
        }

        .window-controls button {
            background: none;
            border: none;
            color: #ffffff;
            cursor: pointer;
            padding: 4px 8px;
            font-size: 16px;
        }

        .content {
            padding: 22px;
        }

        .section {
            margin-bottom: 24px;
        }

        .section-title {
            color: #3a3a3a;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.6px;
            margin-bottom: 14px;
            padding-bottom: 6px;
            border-bottom: 1px solid #bbbbbb;
        }

        .form-row {
            display: flex;
            gap: 18px;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }

        .field {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        label {
            font-size: 13px;
            color: #333333;
        }

        input[type="text"],
        input[type="number"],
        input[type="datetime-local"],
        select {
            background: #ffffff;
            border: 1px solid #999999;
            color: #2a2a2a;
            padding: 7px 10px;
            border-radius: 4px;
            font-size: 14px;
            width: 180px;
        }

        input[type="file"] {
            font-size: 13px;
        }

        input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: #5a5a5a;
            box-shadow: 0 0 0 2px rgba(90, 90, 90, 0.15);
        }

        .checkbox-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .collapsible {
            background: #e8e8e8;
            border-radius: 4px;
            border: 1px solid #bbbbbb;
            overflow: hidden;
        }

        .collapsible + .collapsible {
            margin-top: 12px;
        }

        .collapsible-header {
            padding: 12px 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .collapsible-header:hover {
            background: #dddddd;
        }

        .collapsible-icon {
            font-size: 10px;
            color: #5a5a5a;
            transition: transform 0.2s ease;
        }

        .collapsible.open .collapsible-icon {
            transform: rotate(180deg);
        }

        .collapsible-content {
            padding: 12px 14px 16px;
            border-top: 1px solid #bbbbbb;
            background: #f5f5f5;
            display: none;
        }

        .collapsible.open .collapsible-content {
            display: block;
        }

        .param-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 14px 18px;
        }

        .results-area {
            background: #e8e8e8;
            border: 1px solid #999999;
            border-radius: 4px;
            min-height: 200px;
            padding: 18px;
            color: #2a2a2a;
            font-size: 14px;
            line-height: 1.5;
            white-space: pre-line;
        }

        .results-area.loading {
            color: #777777;
            font-style: italic;
        }

        .button-bar {
            display: flex;
            justify-content: space-between;
            margin-top: 24px;
            padding-top: 18px;
            border-top: 1px solid #bbbbbb;
        }

        button {
            background: #4a4a4a;
            color: #ffffff;
            border: none;
            padding: 10px 22px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s ease;
        }

        button:hover {
            background: #3a3a3a;
        }

        button.secondary {
            background: #cccccc;
            color: #2a2a2a;
        }

        button.secondary:hover {
            background: #bbbbbb;
        }

        .error {
            color: #b33434;
            margin-top: 10px;
            font-size: 13px;
        }

        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            margin-bottom: 14px;
        }

        .metric-card {
            background: #ffffff;
            border: 1px solid #cccccc;
            border-radius: 4px;
            padding: 12px;
        }

        .metric-card h4 {
            font-size: 13px;
            color: #666666;
            margin-bottom: 6px;
        }

        .metric-card span {
            font-size: 18px;
            font-weight: 600;
        }

        .param-list {
            background: #ffffff;
            border: 1px solid #cccccc;
            border-radius: 4px;
            padding: 12px;
            font-size: 13px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px 16px;
        }

        .param-list div {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .param-list span {
            color: #5a5a5a;
        }
    </style>
</head>
<body>
    <div class="window">
        <div class="title-bar">
            <h2>S_01 TrailingMA Backtester</h2>
            <div class="window-controls">
                <button type="button">−</button>
                <button type="button">□</button>
                <button type="button">×</button>
            </div>
        </div>
        <div class="content">
            <form id="backtestForm">
                <div class="section">
                    <div class="section-title">Data</div>
                    <div class="form-row">
                        <div class="checkbox-row">
                            <input type="checkbox" id="dateFilter" checked>
                            <label for="dateFilter">Date Filter</label>
                        </div>
                        <div class="checkbox-row">
                            <input type="checkbox" id="backtester" checked>
                            <label for="backtester">Backtester Enabled</label>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="field">
                            <label for="csvFile">CSV файл (OHLCV)</label>
                            <input type="file" id="csvFile" accept=".csv" required>
                        </div>
                        <div class="field">
                            <label for="startDate">Start</label>
                            <input type="datetime-local" id="startDate" value="2025-04-01T00:00">
                        </div>
                        <div class="field">
                            <label for="endDate">End</label>
                            <input type="datetime-local" id="endDate" value="2025-09-01T00:00">
                        </div>
                        <div class="field">
                            <label for="atrPeriod">ATR Period</label>
                            <input type="number" id="atrPeriod" value="14" min="1">
                        </div>
                    </div>
                </div>

                <div class="section">
                    <div class="section-title">Trend Moving Average</div>
                    <div class="form-row">
                        <div class="field">
                            <label for="maType">MA Type</label>
                            <select id="maType">
                                <option value="EMA">EMA</option>
                                <option value="SMA">SMA</option>
                                <option value="HMA">HMA</option>
                                <option value="WMA">WMA</option>
                                <option value="VWMA">VWMA</option>
                                <option value="VWAP">VWAP</option>
                                <option value="ALMA">ALMA</option>
                                <option value="DEMA">DEMA</option>
                                <option value="KAMA">KAMA</option>
                                <option value="TMA">TMA</option>
                                <option value="T3">T3</option>
                            </select>
                        </div>
                        <div class="field">
                            <label for="maLength">Length</label>
                            <input type="number" id="maLength" value="45" min="0">
                        </div>
                        <div class="field">
                            <label for="closeCountLong">Close Count Long</label>
                            <input type="number" id="closeCountLong" value="7" min="0">
                        </div>
                        <div class="field">
                            <label for="closeCountShort">Close Count Short</label>
                            <input type="number" id="closeCountShort" value="5" min="0">
                        </div>
                    </div>
                </div>

                <div class="collapsible open">
                    <div class="collapsible-header">
                        <span class="collapsible-icon">▼</span>
                        <span class="section-title" style="margin: 0; border: none;">Stops & Filters</span>
                    </div>
                    <div class="collapsible-content">
                        <div class="param-grid">
                            <div class="field">
                                <label for="stopLongX">Stop Long × ATR</label>
                                <input type="number" id="stopLongX" value="2" step="0.1" min="0">
                            </div>
                            <div class="field">
                                <label for="stopLongRR">Long Risk:Reward</label>
                                <input type="number" id="stopLongRR" value="3" step="0.1" min="0">
                            </div>
                            <div class="field">
                                <label for="stopLongLP">Long Lowest Bars</label>
                                <input type="number" id="stopLongLP" value="2" min="1">
                            </div>
                            <div class="field">
                                <label for="stopShortX">Stop Short × ATR</label>
                                <input type="number" id="stopShortX" value="2" step="0.1" min="0">
                            </div>
                            <div class="field">
                                <label for="stopShortRR">Short Risk:Reward</label>
                                <input type="number" id="stopShortRR" value="3" step="0.1" min="0">
                            </div>
                            <div class="field">
                                <label for="stopShortLP">Short Highest Bars</label>
                                <input type="number" id="stopShortLP" value="2" min="1">
                            </div>
                            <div class="field">
                                <label for="stopLongMaxPct">Max Stop % Long</label>
                                <input type="number" id="stopLongMaxPct" value="3" step="0.1" min="0">
                            </div>
                            <div class="field">
                                <label for="stopShortMaxPct">Max Stop % Short</label>
                                <input type="number" id="stopShortMaxPct" value="3" step="0.1" min="0">
                            </div>
                            <div class="field">
                                <label for="stopLongMaxDays">Max Days Long</label>
                                <input type="number" id="stopLongMaxDays" value="2" min="0">
                            </div>
                            <div class="field">
                                <label for="stopShortMaxDays">Max Days Short</label>
                                <input type="number" id="stopShortMaxDays" value="4" min="0">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="collapsible open">
                    <div class="collapsible-header">
                        <span class="collapsible-icon">▼</span>
                        <span class="section-title" style="margin: 0; border: none;">Trailing Stops</span>
                    </div>
                    <div class="collapsible-content">
                        <div class="param-grid">
                            <div class="field">
                                <label for="trailRRLong">Trail RR Long</label>
                                <input type="number" id="trailRRLong" value="1" step="0.1" min="0">
                            </div>
                            <div class="field">
                                <label for="trailRRShort">Trail RR Short</label>
                                <input type="number" id="trailRRShort" value="1" step="0.1" min="0">
                            </div>
                            <div class="field">
                                <label for="trailLongType">Trail MA Long</label>
                                <select id="trailLongType">
                                    <option value="SMA">SMA</option>
                                    <option value="EMA">EMA</option>
                                    <option value="HMA">HMA</option>
                                    <option value="WMA">WMA</option>
                                    <option value="VWMA">VWMA</option>
                                    <option value="VWAP">VWAP</option>
                                    <option value="ALMA">ALMA</option>
                                    <option value="DEMA">DEMA</option>
                                    <option value="KAMA">KAMA</option>
                                    <option value="TMA">TMA</option>
                                    <option value="T3">T3</option>
                                </select>
                            </div>
                            <div class="field">
                                <label for="trailLongLength">Trail Long Length</label>
                                <input type="number" id="trailLongLength" value="160" min="0">
                            </div>
                            <div class="field">
                                <label for="trailLongOffset">Trail Long Offset %</label>
                                <input type="number" id="trailLongOffset" value="-1" step="0.1">
                            </div>
                            <div class="field">
                                <label for="trailShortType">Trail MA Short</label>
                                <select id="trailShortType">
                                    <option value="SMA">SMA</option>
                                    <option value="EMA">EMA</option>
                                    <option value="HMA">HMA</option>
                                    <option value="WMA">WMA</option>
                                    <option value="VWMA">VWMA</option>
                                    <option value="VWAP">VWAP</option>
                                    <option value="ALMA">ALMA</option>
                                    <option value="DEMA">DEMA</option>
                                    <option value="KAMA">KAMA</option>
                                    <option value="TMA">TMA</option>
                                    <option value="T3">T3</option>
                                </select>
                            </div>
                            <div class="field">
                                <label for="trailShortLength">Trail Short Length</label>
                                <input type="number" id="trailShortLength" value="160" min="0">
                            </div>
                            <div class="field">
                                <label for="trailShortOffset">Trail Short Offset %</label>
                                <input type="number" id="trailShortOffset" value="1" step="0.1">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <div class="section-title">Risk Settings</div>
                    <div class="form-row">
                        <div class="field">
                            <label for="riskPerTrade">Risk per Trade %</label>
                            <input type="number" id="riskPerTrade" value="2" step="0.1" min="0">
                        </div>
                        <div class="field">
                            <label for="contractSize">Contract Size</label>
                            <input type="number" id="contractSize" value="0.01" step="0.01" min="0">
                        </div>
                        <div class="field">
                            <label for="commissionRate">Commission Rate</label>
                            <input type="number" id="commissionRate" value="0.0005" step="0.0001" min="0">
                        </div>
                    </div>
                </div>

                <div class="section">
                    <div class="section-title">Results</div>
                    <div id="results" class="results-area">Нажмите «Run» для запуска бэктеста…</div>
                    <div id="error" class="error" role="alert" style="display:none;"></div>
                </div>

                <div class="button-bar">
                    <button type="button" class="secondary" id="defaultsBtn">Defaults</button>
                    <div style="display: flex; gap: 10px;">
                        <button type="button" class="secondary" id="cancelBtn">Cancel</button>
                        <button type="submit" id="runBtn">Run</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script>
        const collapsibles = document.querySelectorAll('.collapsible');
        collapsibles.forEach((collapsible) => {
            const header = collapsible.querySelector('.collapsible-header');
            header.addEventListener('click', () => {
                collapsible.classList.toggle('open');
            });
        });

        const defaults = {
            dateFilter: true,
            backtester: true,
            start: '2025-04-01T00:00',
            end: '2025-09-01T00:00',
            atrPeriod: 14,
            maType: 'EMA',
            maLength: 45,
            closeCountLong: 7,
            closeCountShort: 5,
            stopLongX: 2,
            stopLongRR: 3,
            stopLongLP: 2,
            stopShortX: 2,
            stopShortRR: 3,
            stopShortLP: 2,
            stopLongMaxPct: 3,
            stopShortMaxPct: 3,
            stopLongMaxDays: 2,
            stopShortMaxDays: 4,
            trailRRLong: 1,
            trailRRShort: 1,
            trailLongType: 'SMA',
            trailLongLength: 160,
            trailLongOffset: -1,
            trailShortType: 'SMA',
            trailShortLength: 160,
            trailShortOffset: 1,
            riskPerTrade: 2,
            contractSize: 0.01,
            commissionRate: 0.0005
        };

        function setDefaults() {
            document.getElementById('dateFilter').checked = defaults.dateFilter;
            document.getElementById('backtester').checked = defaults.backtester;
            document.getElementById('startDate').value = defaults.start;
            document.getElementById('endDate').value = defaults.end;
            document.getElementById('atrPeriod').value = defaults.atrPeriod;
            document.getElementById('maType').value = defaults.maType;
            document.getElementById('maLength').value = defaults.maLength;
            document.getElementById('closeCountLong').value = defaults.closeCountLong;
            document.getElementById('closeCountShort').value = defaults.closeCountShort;
            document.getElementById('stopLongX').value = defaults.stopLongX;
            document.getElementById('stopLongRR').value = defaults.stopLongRR;
            document.getElementById('stopLongLP').value = defaults.stopLongLP;
            document.getElementById('stopShortX').value = defaults.stopShortX;
            document.getElementById('stopShortRR').value = defaults.stopShortRR;
            document.getElementById('stopShortLP').value = defaults.stopShortLP;
            document.getElementById('stopLongMaxPct').value = defaults.stopLongMaxPct;
            document.getElementById('stopShortMaxPct').value = defaults.stopShortMaxPct;
            document.getElementById('stopLongMaxDays').value = defaults.stopLongMaxDays;
            document.getElementById('stopShortMaxDays').value = defaults.stopShortMaxDays;
            document.getElementById('trailRRLong').value = defaults.trailRRLong;
            document.getElementById('trailRRShort').value = defaults.trailRRShort;
            document.getElementById('trailLongType').value = defaults.trailLongType;
            document.getElementById('trailLongLength').value = defaults.trailLongLength;
            document.getElementById('trailLongOffset').value = defaults.trailLongOffset;
            document.getElementById('trailShortType').value = defaults.trailShortType;
            document.getElementById('trailShortLength').value = defaults.trailShortLength;
            document.getElementById('trailShortOffset').value = defaults.trailShortOffset;
            document.getElementById('riskPerTrade').value = defaults.riskPerTrade;
            document.getElementById('contractSize').value = defaults.contractSize;
            document.getElementById('commissionRate').value = defaults.commissionRate;
        }

        setDefaults();

        document.getElementById('defaultsBtn').addEventListener('click', () => {
            setDefaults();
            document.getElementById('results').textContent = 'Параметры сброшены к значениям по умолчанию.';
            document.getElementById('results').classList.remove('loading');
            document.getElementById('error').style.display = 'none';
        });

        document.getElementById('cancelBtn').addEventListener('click', () => {
            document.getElementById('backtestForm').reset();
            setDefaults();
            document.getElementById('results').textContent = 'Форма очищена. Запустите бэктест заново.';
            document.getElementById('results').classList.remove('loading');
            document.getElementById('error').style.display = 'none';
        });

        function gatherPayload() {
            return {
                dateFilter: document.getElementById('dateFilter').checked,
                backtester: document.getElementById('backtester').checked,
                start: document.getElementById('startDate').value,
                end: document.getElementById('endDate').value,
                atrPeriod: Number(document.getElementById('atrPeriod').value),
                maType: document.getElementById('maType').value,
                maLength: Number(document.getElementById('maLength').value),
                closeCountLong: Number(document.getElementById('closeCountLong').value),
                closeCountShort: Number(document.getElementById('closeCountShort').value),
                stopLongX: Number(document.getElementById('stopLongX').value),
                stopLongRR: Number(document.getElementById('stopLongRR').value),
                stopLongLP: Number(document.getElementById('stopLongLP').value),
                stopShortX: Number(document.getElementById('stopShortX').value),
                stopShortRR: Number(document.getElementById('stopShortRR').value),
                stopShortLP: Number(document.getElementById('stopShortLP').value),
                stopLongMaxPct: Number(document.getElementById('stopLongMaxPct').value),
                stopShortMaxPct: Number(document.getElementById('stopShortMaxPct').value),
                stopLongMaxDays: Number(document.getElementById('stopLongMaxDays').value),
                stopShortMaxDays: Number(document.getElementById('stopShortMaxDays').value),
                trailRRLong: Number(document.getElementById('trailRRLong').value),
                trailRRShort: Number(document.getElementById('trailRRShort').value),
                trailLongType: document.getElementById('trailLongType').value,
                trailLongLength: Number(document.getElementById('trailLongLength').value),
                trailLongOffset: Number(document.getElementById('trailLongOffset').value),
                trailShortType: document.getElementById('trailShortType').value,
                trailShortLength: Number(document.getElementById('trailShortLength').value),
                trailShortOffset: Number(document.getElementById('trailShortOffset').value),
                riskPerTrade: Number(document.getElementById('riskPerTrade').value),
                contractSize: Number(document.getElementById('contractSize').value),
                commissionRate: Number(document.getElementById('commissionRate').value)
            };
        }

        function renderResults(data) {
            const resultsEl = document.getElementById('results');
            const metrics = data.metrics || {};
            const params = data.parameters || {};

            const metricsHtml = `
                <div class="metrics">
                    <div class="metric-card">
                        <h4>Net Profit %</h4>
                        <span>${metrics.net_profit_pct?.toFixed?.(2) ?? metrics.net_profit_pct ?? '—'}</span>
                    </div>
                    <div class="metric-card">
                        <h4>Max Drawdown %</h4>
                        <span>${metrics.max_drawdown_pct?.toFixed?.(2) ?? metrics.max_drawdown_pct ?? '—'}</span>
                    </div>
                    <div class="metric-card">
                        <h4>Total Trades</h4>
                        <span>${metrics.total_trades ?? '—'}</span>
                    </div>
                </div>`;

            const paramEntries = Object.entries(params)
                .map(([key, value]) => {
                    let displayValue = value;
                    if (typeof value === 'number') {
                        displayValue = Number.isInteger(value) ? value : value.toFixed(4);
                    }
                    return `<div><strong>${key}</strong><span>${displayValue ?? '—'}</span></div>`;
                })
                .join('');

            const paramsHtml = `<div class="param-list">${paramEntries}</div>`;

            resultsEl.innerHTML = metricsHtml + paramsHtml;
            resultsEl.classList.remove('loading');
        }

        async function submitForm(event) {
            event.preventDefault();
            const resultsEl = document.getElementById('results');
            const errorEl = document.getElementById('error');
            errorEl.style.display = 'none';

            const fileInput = document.getElementById('csvFile');
            if (!fileInput.files.length) {
                errorEl.textContent = 'Пожалуйста, выберите CSV файл с данными.';
                errorEl.style.display = 'block';
                return;
            }

            const payload = gatherPayload();
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('payload', JSON.stringify(payload));

            resultsEl.textContent = 'Выполняется расчёт…';
            resultsEl.classList.add('loading');

            try {
                const response = await fetch('/api/backtest', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const message = await response.text();
                    throw new Error(message || 'Ошибка выполнения бэктеста');
                }

                const data = await response.json();
                renderResults(data);
            } catch (err) {
                resultsEl.textContent = 'Произошла ошибка.';
                resultsEl.classList.remove('loading');
                errorEl.textContent = err.message;
                errorEl.style.display = 'block';
            }
        }

        document.getElementById('backtestForm').addEventListener('submit', submitForm);
    </script>
</body>
</html>
